name: Sync PR Comment to Linked Issue

on:
  issue_comment:
    types: [created]
  # Force refresh

permissions:
  issues: write
  pull-requests: read

jobs:
  update-issue:
    if: github.event.issue.pull_request != null
    runs-on: ubuntu-latest
    
    steps:
      - name: Sync comment to linked issue
        uses: actions/github-script@v7
        with:
          script: |
            const commenter = context.payload.comment.user.login;
            const commenterType = context.payload.comment.user.type;
            
            // Exclude bot accounts
            const excludedBots = [
              'github-actions[bot]',
              'github-actions',
              'copilot'
            ];
            
            const isBot = commenterType === 'Bot' || 
                         excludedBots.some(bot => commenter.toLowerCase().includes(bot.toLowerCase()));
            
            if (isBot) {
              core.info(`Skipping bot comment from ${commenter}`);
              return;
            }

            // Get PR details
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.issue.number
            });

            // Search for linked issue in PR title and body
            const text = `${pr.data.title}\n\n${pr.data.body || ''}`;
            // Match keywords (closes, fixes, resolves) followed by issue number
            const match = text.match(/(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#(\d+)/i);
            
            let issueNumber = match ? match[1] : null;
            
            // If no keyword match, use REST API to get timeline events
            if (!issueNumber) {
              try {
                const { data: timeline } = await github.rest.issues.listEventsForTimeline({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number,
                  per_page: 100
                });
                
                core.info(`Fetched ${timeline.length} timeline events`);
                
                // Look for connected events
                const connectedEvents = timeline.filter(event => event.event === 'connected');
                core.info(`Found ${connectedEvents.length} connected events`);
                
                if (connectedEvents.length > 0) {
                  // Log the structure to debug
                  core.info(`First connected event: ${JSON.stringify(connectedEvents[0], null, 2)}`);
                  
                  // Try different possible structures
                  const firstEvent = connectedEvents[0];
                  if (firstEvent.source && firstEvent.source.issue && firstEvent.source.issue.number) {
                    issueNumber = firstEvent.source.issue.number.toString();
                  } else if (firstEvent.issue && firstEvent.issue.number) {
                    issueNumber = firstEvent.issue.number.toString();
                  }
                  
                  if (issueNumber) {
                    core.info(`Found manually linked issue #${issueNumber}`);
                  }
                }
              } catch (error) {
                core.info(`Could not fetch timeline events: ${error.message}`);
              }
            }
            
            if (!issueNumber) {
              core.info('No linked issue found in PR title or body.');
              return;
            }

            core.info(`Found linked issue #${issueNumber}`);

            // Create comment on the linked issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number(issueNumber),
              body: `↩️ **Update from [PR #${context.payload.issue.number}](${pr.data.html_url})**\n\n> ${context.payload.comment.body.trim()}\n\n_Comment by [@${context.payload.comment.user.login}](${context.payload.comment.user.html_url})_`
            });

            core.info(`Successfully synced comment to issue #${issueNumber}`);